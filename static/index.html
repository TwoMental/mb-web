<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Modbus Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .card {
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            border-radius: 8px;
            margin: 10px;
        }

        .container {
            display: flex;
            justify-content: center; /* Center all columns horizontally */
            align-items: flex-start; /* Align items at the top */
            width: 100%; /* Fill available space */
            margin-top: 20px; /* Top margin */
        }

        .left-panel, .right-panel {
            display: flex;
            flex-direction: column; /* Stack items vertically */
        }

        .left-panel {
            width: 25%; /* Left column width */
            margin-right: 20px; /* Gap between left and right columns */
        }

        .right-panel {
            width: 70%; /* Right column width */
        }

        h1, h2 {
            color: #0056b3;
        }

        input[type="text"], input[type="number"], select {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: calc(100% - 16px); /* Full width minus padding */
        }

        .button-common {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0px;
        }

        .button-common:hover {
            background-color: #0056b3;
        }

        .button-common:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .error {
            color: #cb3333;
        }

        .button-delete-all {
            background-color: #cb3333; /* Red background */
        }

        .button-delete-all:hover {
            background-color: #9f1717; /* Dark red background */
        }

        .input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .input-address-name, .input-address {
            flex: 1;
            padding: 8px;
            margin: 5px 0px;
        }

        .type-select {
            margin: 5px 0px;
        }

        .decimal, .bytes {
            min-width: 20%; /* Fixed width for results */
            margin-left: 10px;
            text-align: left;
        }

        .remove-btn {
            padding: 0px 8px;
            margin: 0px;
            width: 24px;
            height: 24px;
            background-color: #cb3333; /* Red background */
            color: white;
            border: none;
            border-radius: 100px;
            cursor: pointer;
        }

        .remove-btn:hover {
            background-color: #9f1717; /* Dark red background */
        }

        input.highlight {
            border: 2px solid #ffcc00 !important; /* Border style used when highlighting (overrides defaults) */
            transition: border-color 0.3s ease; /* Add a border-color transition */
        }

        .connection-tabs {
            display: flex;
            margin: 10px 0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .tab-button {
            flex: 1;
            padding: 8px 12px;
            background-color: #f0f0f0;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #555;
        }

        .tab-button.active {
            background-color: #007bff;
            color: #fff;
        }

        .connection-pane {
            display: none;
            margin-bottom: 10px;
        }

        .connection-pane.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .serial-port-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .button-inline {
            padding: 8px 12px;
            margin: 5px 0;
        }

        .serial-port-row select {
            flex: 1;
            width: 100%;
        }

        .serial-port-row .button-inline {
            flex: 0 0 auto;
        }

        .operation-tabs {
            display: flex;
            margin: 10px 0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .operation-pane {
            display: none;
            margin-top: 10px;
        }

        .operation-pane.active {
            display: block;
        }

        .write-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            gap: 8px;
        }

        .write-name,
        .write-address,
        .write-value {
            flex: 1;
            padding: 8px;
            margin: 5px 0;
        }

        .write-type-select {
            margin: 5px 0;
        }

        .write-status {
            min-width: 120px;
            font-size: 12px;
            color: #555;
        }

        .write-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .action-bar.section-split {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .action-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .primary-action {
            background-color: #28a745;
        }

        .primary-action:hover {
            background-color: #1f7d34;
        }

        .primary-action.secondary {
            background-color: #28a745;
        }

        .primary-action.secondary:hover {
            background-color: #1f7d34;
        }

        .download-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        /* Dropdown styles */
        select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 200px;
        }
        .download {
            display: none;
        }
        .input-button-bottom {
            display: none;
        }

        #versionInfo {
            position: fixed;
            bottom: 0;
            color: rgba(121, 117, 117, 0.603);
            padding: 10px;
            border-radius: 5px;
            z-index: -1; /* Push element to the background with a negative z-index */
        }

        #conversionCard {
            position: fixed;
            top: 0;
            z-index: 1000;
            width: 100%;
            background-color: #fffffff9;
            margin-top: 0px;
            padding: 15px 0px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around; /* Evenly distribute conversion fields */
            align-items: center; /* Vertically center items */
        }

        .conversion-container {
            display: flex;
            width: 90%; /* Stretch container to the card width */
            justify-content: space-around; /* Space elements evenly */
        }

        .conversion-field {
            display: flex;
            flex-direction: column; /* Stack labels and inputs vertically */
            align-items: center; /* Center align */
            flex-grow: 1; /* Let each field share remaining space */
            margin: 0px 10px; /* Spacing between fields */
        }

        .binary-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 1px solid rgba(128, 128, 128, 0.3); /* Thin, gray, semi-transparent border */
            border-right: 1px solid rgba(128, 128, 128, 0.3); /* Thin, gray, semi-transparent border */
            padding: 0 20px;
            flex: 0.5; /
        }

        .decimal-positive, .decimal-negative {
            display: flex;
            flex-direction: row;
            flex: 1;
            margin: 0 20px;  
        }

        .conversion-label {
            color: #7a7a7a;
            height: 20px; /* Label height */
            margin-bottom: 5px; /* Spacing between label and input */
        }
    </style>
</head>
<body>
    <div id="conversionCard" class="card card-config">
        <div class="conversion-container">
            <div class="decimal-positive">
                <div class="conversion-field">
                    <div class="conversion-label">Decimal (Positive)</div>
                    <input type="text" id="decimal" class="conversion-input" placeholder="Double-click Value to autofill" oninput="convertFrom('decimal', 10)">
                </div>
                <div class="conversion-field">
                    <div class="conversion-label">U16</div>
                    <input type="text" id="U16" class="conversion-input" placeholder="Double-click Bytes to autofill" oninput="convertFrom('U16', 16)">
                </div>
                <div class="conversion-field">
                    <div class="conversion-label">U32</div>
                    <input type="text" id="U32" class="conversion-input" oninput="convertFrom('U32', 16)">
                </div>
            </div>
            <div class="binary-section">
                <div class="conversion-label">Binary</div>
                <input type="text" id="binary" class="conversion-input" oninput="convertFrom('binary', 2)">
            </div>
            <div class="decimal-negative">
                <div class="conversion-field">
                    <div class="conversion-label">Decimal (Negative)</div>
                    <input type="text" id="decimalm" class="conversion-input" oninput="convertFrom('decimalm', 10)">
                </div>
                <div class="conversion-field">
                    <div class="conversion-label">S16</div>
                    <input type="text" id="S16" class="conversion-input" oninput="convertFrom('S16', 16)">
                </div>
                <div class="conversion-field">
                    <div class="conversion-label">S32</div>
                    <input type="text" id="S32" class="conversion-input" oninput="convertFrom('S32', 16)">
                </div>
            </div>
        </div>
                     
    </div>
    <div class="container">
        <div class="left-panel">
            <div class="card card-config" id="modbusCard">
                <!-- Modbus connection configuration -->
                <h1>Connection</h1>
                <div class="connection-tabs">
                    <button class="tab-button active" data-connection="tcp">TCP</button>
                    <button class="tab-button" data-connection="rtu">RTU</button>
                </div>
                <div id="tcpConfig" class="connection-pane active">
                    <label for="host">Host:</label>
                    <input type="text" id="host" value="192.168.1.200" placeholder="Enter host">
                    <label for="port">Port:</label>
                    <input type="number" id="port" value="502" min="1" max="65535" placeholder="Enter port">
                </div>
                <div id="rtuConfig" class="connection-pane">
                    <label for="rtuPortSelect">Serial Port:</label>
                    <div class="serial-port-row">
                        <select id="rtuPortSelect"></select>
                        <button type="button" class="button-common button-inline" id="refreshSerialPorts">Refresh</button>
                    </div>
                    <input type="text" id="rtuPortCustom" class="conversion-input hidden" placeholder="Enter serial port">
                    <label for="baudRate">Baud Rate:</label>
                    <select id="baudRate">
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                    </select>
                    <label for="dataBits">Data Bits:</label>
                    <select id="dataBits">
                        <option value="7">7</option>
                        <option value="8" selected>8</option>
                    </select>
                    <label for="parity">Parity:</label>
                    <select id="parity">
                        <option value="N" selected>None</option>
                        <option value="E">Even</option>
                        <option value="O">Odd</option>
                    </select>
                    <label for="stopBits">Stop Bits:</label>
                    <select id="stopBits">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                    </select>
                </div>
                <label for="slaveId">Slave ID:</label>
                <input type="number" id="slaveId" value="1" min="0" max="247" placeholder="Enter slave ID (0-247)">
                <button class="button-common" id="configureButton" onclick="configureServer()">Connect</button>
                <p id="configResponse"></p>
            </div>
            <div class="card download" id="download">
                <select id="resourceSelect">
                </select>
                <button class="download-button" onclick="downloadSelected()">Download</button>
            </div>
        </div>
        <div class="right-panel">
            <div class="card card-operation" id="operationCard">
                <div class="operation-tabs">
                    <button class="tab-button active" data-operation="read">Read</button>
                    <button class="tab-button" data-operation="write">Write</button>
                </div>
                <div id="readPanel" class="operation-pane active">
                    <div class="action-bar">
                        <h1 style="margin: 0 20px 0 0;">Read Data</h1>
                        <div class="action-group">
                            <button class="button-common primary-action" onclick="callApi()">⏍ Read Values</button>
                        </div>
                    </div>
                    <div class="action-bar section-split">
                        <div class="action-group">
                            <button class="button-common" onclick="addInput()">+ Add Address</button>
                            <button class="button-common button-sort-addr" onclick="sortInputRows()">↓ Sort Addresses</button>
                            <button class="button-common button-delete-all" onclick="cleanAddress()">x Clear Addresses</button>
                        </div>
                    </div>
                    <div id="inputContainer"></div>
                    <div class="action-bar" id="input-button-bottom">
                        <div class="action-group">
                            <button class="button-common" onclick="addInput()">+ Add Address</button>
                            <button class="button-common button-sort-addr" onclick="sortInputRows()">↓ Sort Addresses</button>
                            <button class="button-common button-delete-all" onclick="cleanAddress()">x Clear Addresses</button>
                        </div>
                        <div class="action-group">
                            <button class="button-common primary-action" onclick="callApi()">⏍ Read Values</button>
                        </div>
                    </div>
                </div>
                <div id="writePanel" class="operation-pane">
                    <div class="action-bar">
                        <h1 style="margin: 0 20px 0 0;">Write Data</h1>
                        <div class="action-group">
                            <button class="button-common primary-action secondary" onclick="callWriteApi()">⏎ Write Values</button>
                        </div>
                    </div>
                    <div class="action-bar section-split">
                        <div class="action-group">
                            <button class="button-common" onclick="addWriteRow()">+ Add Item</button>
                            <button class="button-common button-delete-all" onclick="cleanWriteRows()">x Clear Items</button>
                        </div>
                    </div>
                    <div id="writeContainer"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="vsrsion-infos" id="versionInfo">
        <span id="build-time"></span>
        <span id="git-commit"></span>
    </div>

    <script>
        const CUSTOM_SERIAL_OPTION = '__serial_custom__';
        const STATUS_POLL_INTERVAL = 5000;
        let connectionMode = 'tcp';
        let operationMode = 'read';
        let serialPortsLoaded = false;
        let serialPortsLoading = false;
        let pendingSerialPortValue = null;
        let writeRowsInitialized = false;
        let connectionStatusTimer = null;

        document.addEventListener('DOMContentLoaded', function() {
            const storedOperationMode = localStorage.getItem('operationMode');
            if (storedOperationMode === 'read' || storedOperationMode === 'write') {
                operationMode = storedOperationMode;
            }

            ajustForConversionCard();
            initConnectionTabs();
            initWriteRows();
            initOperationTabs();
            needDownload();
            loadServerConfig();
            fetchSerialPorts(false);
            initAddresses();  // Restore saved addresses when the page loads
            autoCal();  // Rebind conversion shortcuts automatically
            versionInfo();
            startConnectionStatusWatcher();
        });

        function ajustForConversionCard() {
            const conversionCardHeight = document.getElementById('conversionCard').offsetHeight;
            document.body.style.paddingTop = conversionCardHeight + 'px'; // Offset body padding to avoid overlap
        }

        function versionInfo() {
            fetch("/version-info") // Request version information from the backend
                .then(response => response.json())
                .then(data => {
                    const buildTime = document.getElementById("build-time");
                    buildTime.textContent = `BuildTime: ${data.build_time}`;


                    const gitCommit = document.getElementById("git-commit");
                    gitCommit.textContent = `GitCommit: ${data.git_commit}`;
                })
                .catch(error => console.error("Error fetching data:", error));
        }

        function needDownload() {
            fetch("/allow-download") // Request download permission from the backend
                .then(response => response.json())
                .then(data => {
                    if (data.allow) { // Show download controls when proxying is enabled
                        document.getElementById("download").style.display = "block";
                        updateResourceList();
                    }
                })
                .catch(error => console.error("Error fetching data:", error));
        }

        function updateResourceList() {
            fetch("/resource-list") // Request the resource list from the backend
                .then(response => response.json())
                .then(data => {
                    const resourceList = document.getElementById("resourceSelect");
                    data.files.forEach(file => { // Populate the dropdown with the available files
                        const option = document.createElement("option");
                        option.textContent = file;
                        option.value = file;
                        resourceList.appendChild(option);
                    });
                })
                .catch(error => console.error("Error fetching data:", error));
        }

        // Add double-click shortcuts for result fields
        function autoCal() {
            autoDecimal()
            autoHex()
        }

        function autoDecimal() {
            // Get every element with class 'decimal'
            const decimalElements = document.querySelectorAll('.decimal');

            // Iterate through each decimal element
            decimalElements.forEach(decimalElement => {
                // Bind a double-click listener
                decimalElement.addEventListener('dblclick', () => {
                    // Reference the target input element
                    const targetInput = document.getElementById('decimal');
                    
                    // Copy the double-clicked decimal value
                    targetInput.value = decimalElement.textContent;
                    targetInput.classList.add('highlight'); // Add highlight styling

                    setTimeout(() => {
                        targetInput.classList.remove('highlight'); // Remove highlight styling
                    }, 3000); // Remove the highlight after three seconds

                    // Trigger conversion for the target input
                    convertFrom('decimal', 10);
                });
            });
        }

        function autoHex() {
            // Get every element with class 'bytes'
            const byteElements = document.querySelectorAll('.bytes');

            // Iterate through each bytes element
            byteElements.forEach(byteElement => {
                // Bind a double-click listener
                byteElement.addEventListener('dblclick', () => {
                    const rawText = byteElement.textContent.replace('Bytes:', '').trim();
                    if (!rawText) {
                        return;
                    }

                    const hexPairs = rawText.split(/\s+/).map(fragment => fragment.replace(/0x/gi, ''));
                    const hexString = hexPairs.join('').toUpperCase();
                    if (!hexString) {
                        return;
                    }

                    const padded16 = hexString.padStart(4, '0');
                    const padded32 = hexString.padStart(8, '0');

                    const u16Input = document.getElementById('U16');
                    const u32Input = document.getElementById('U32');

                    if (!u16Input || !u32Input) {
                        return;
                    }

                    u16Input.value = padded16;
                    u32Input.value = padded32;

                    [u16Input, u32Input].forEach(input => {
                        input.classList.add('highlight');
                        setTimeout(() => input.classList.remove('highlight'), 3000);
                    });

                    // Trigger conversion for 32-bit representation
                    convertFrom('U32', 16);
                });
            });
        }

        function initConnectionTabs() {
            const tabButtons = document.querySelectorAll('.connection-tabs .tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const mode = button.getAttribute('data-connection');
                    setConnectionMode(mode);
                });
            });

            const portSelect = document.getElementById('rtuPortSelect');
            if (portSelect) {
                portSelect.addEventListener('change', () => {
                    toggleCustomSerialPort(portSelect.value);
                });
            }

            const refreshButton = document.getElementById('refreshSerialPorts');
            if (refreshButton) {
                refreshButton.addEventListener('click', () => fetchSerialPorts(true));
            }

            setConnectionMode(connectionMode);
        }

        function setConnectionMode(mode) {
            if (!mode) {
                return;
            }

            connectionMode = mode;

            document.querySelectorAll('.connection-tabs .tab-button').forEach(button => {
                const isActive = button.getAttribute('data-connection') === mode;
                button.classList.toggle('active', isActive);
            });

            document.querySelectorAll('.connection-pane').forEach(pane => {
                const isTcp = mode === 'tcp' && pane.id === 'tcpConfig';
                const isRtu = mode === 'rtu' && pane.id === 'rtuConfig';
                pane.classList.toggle('active', isTcp || isRtu);
            });

            if (mode === 'rtu' && !serialPortsLoaded && !serialPortsLoading) {
                fetchSerialPorts(false);
            }

            if (mode === 'rtu') {
                const select = document.getElementById('rtuPortSelect');
                if (select) {
                    toggleCustomSerialPort(select.value);
                }
            } else {
                toggleCustomSerialPort('');
            }
        }

        function initOperationTabs() {
            const buttons = document.querySelectorAll('.operation-tabs .tab-button');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const mode = button.getAttribute('data-operation');
                    setOperationMode(mode);
                });
            });

            setOperationMode(operationMode);
        }

        function setOperationMode(mode) {
            if (mode !== 'read' && mode !== 'write') {
                mode = 'read';
            }

            operationMode = mode;

            document.querySelectorAll('.operation-tabs .tab-button').forEach(button => {
                const isActive = button.getAttribute('data-operation') === mode;
                button.classList.toggle('active', isActive);
            });

            const readPane = document.getElementById('readPanel');
            const writePane = document.getElementById('writePanel');
            if (readPane) {
                readPane.classList.toggle('active', mode === 'read');
            }
            if (writePane) {
                writePane.classList.toggle('active', mode === 'write');
            }

            if (mode === 'write') {
                focusFirstWriteRow();
            }

            localStorage.setItem('operationMode', operationMode);
        }

        function fetchSerialPorts(force) {
            if (serialPortsLoading) {
                return;
            }

            if (force) {
                serialPortsLoaded = false;
            }

            if (serialPortsLoaded && !force) {
                if (pendingSerialPortValue !== null) {
                    setSerialPortSelection(pendingSerialPortValue);
                    pendingSerialPortValue = null;
                }
                return;
            }

            serialPortsLoading = true;
            fetch("/serial-ports")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch serial ports');
                    }
                    return response.json();
                })
                .then(data => {
                    const ports = Array.isArray(data.ports) ? data.ports : [];
                    populateSerialPortOptions(ports);
                    serialPortsLoaded = true;

                    if (pendingSerialPortValue !== null) {
                        setSerialPortSelection(pendingSerialPortValue);
                        pendingSerialPortValue = null;
                    } else {
                        toggleCustomSerialPort(document.getElementById('rtuPortSelect').value);
                    }
                })
                .catch(error => {
                    console.error("Error fetching serial ports:", error);
                    populateSerialPortOptions([]);
                    serialPortsLoaded = false;

                    if (pendingSerialPortValue !== null) {
                        setSerialPortSelection(pendingSerialPortValue);
                        pendingSerialPortValue = null;
                    }
                })
                .finally(() => {
                    serialPortsLoading = false;
                });
        }

        function populateSerialPortOptions(ports) {
            const select = document.getElementById('rtuPortSelect');
            if (!select) {
                return;
            }

            select.innerHTML = '';

            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = ports.length ? 'Select a serial port' : 'No ports detected';
            select.appendChild(placeholder);

            ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = port;
                select.appendChild(option);
            });

            const customOption = document.createElement('option');
            customOption.value = CUSTOM_SERIAL_OPTION;
            customOption.textContent = 'Custom...';
            select.appendChild(customOption);
        }

        function setSerialPortSelection(value) {
            const select = document.getElementById('rtuPortSelect');
            const customInput = document.getElementById('rtuPortCustom');
            if (!select || !customInput) {
                return;
            }

            if (!value) {
                select.value = '';
                toggleCustomSerialPort('');
                customInput.value = '';
                return;
            }

            const options = Array.from(select.options);
            const matched = options.find(option => option.value === value);
            if (matched) {
                select.value = value;
                toggleCustomSerialPort(value);
                customInput.value = '';
                return;
            }

            select.value = CUSTOM_SERIAL_OPTION;
            toggleCustomSerialPort(CUSTOM_SERIAL_OPTION);
            customInput.value = value;
        }

        function toggleCustomSerialPort(selectedValue) {
            const customInput = document.getElementById('rtuPortCustom');
            if (!customInput) {
                return;
            }

            if (selectedValue === CUSTOM_SERIAL_OPTION) {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
                if (selectedValue !== CUSTOM_SERIAL_OPTION && selectedValue !== '') {
                    customInput.value = selectedValue;
                }
            }
        }

        function startConnectionStatusWatcher() {
            if (connectionStatusTimer) {
                clearInterval(connectionStatusTimer);
            }
            updateConnectionStatus();
            connectionStatusTimer = setInterval(updateConnectionStatus, STATUS_POLL_INTERVAL);
        }

        function updateConnectionStatus() {
            fetch('/connection-status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch connection status');
                    }
                    return response.json();
                })
                .then(data => {
                    const responseDisplay = document.getElementById('configResponse');
                    if (!responseDisplay) {
                        return;
                    }

                    if (data.connected) {
                        const mode = (data.mode || 'unknown').toUpperCase();
                        let suffix = '';
                        if (data.last_alive) {
                            const last = new Date(data.last_alive);
                            if (!Number.isNaN(last.getTime())) {
                                suffix = ` • Last response ${last.toLocaleTimeString()}`;
                            }
                        }
                        responseDisplay.textContent = `Connected (${mode})${suffix}`;
                        responseDisplay.classList.remove('error');
                    } else if (data.last_error) {
                        responseDisplay.textContent = `Disconnected: ${data.last_error}`;
                        responseDisplay.classList.add('error');
                    } else {
                        responseDisplay.textContent = 'Not connected';
                        responseDisplay.classList.add('error');
                    }
                })
                .catch(() => {
                    const responseDisplay = document.getElementById('configResponse');
                    if (responseDisplay) {
                        responseDisplay.textContent = 'Connection status unavailable';
                        responseDisplay.classList.add('error');
                    }
                });
        }

        function loadServerConfig() {
            const storedMode = localStorage.getItem('connectionMode');
            if (storedMode === 'tcp' || storedMode === 'rtu') {
                connectionMode = storedMode;
            }
            setConnectionMode(connectionMode);

            const hostInput = document.getElementById('host');
            const portInput = document.getElementById('port');
            const slaveInput = document.getElementById('slaveId');

            const storedHost = localStorage.getItem('host');
            const storedPort = localStorage.getItem('port');
            const storedSlaveId = localStorage.getItem('slaveId');

            if (storedHost && hostInput) {
                hostInput.value = storedHost;
            }
            if (storedPort && portInput) {
                portInput.value = storedPort;
            }
            if (storedSlaveId && slaveInput) {
                slaveInput.value = storedSlaveId;
            }

            const storedBaudRate = localStorage.getItem('rtuBaudRate') || '9600';
            const storedDataBits = localStorage.getItem('rtuDataBits') || '8';
            const storedParity = localStorage.getItem('rtuParity') || 'N';
            const storedStopBits = localStorage.getItem('rtuStopBits') || '1';
            const storedSerialPort = localStorage.getItem('rtuPort');

            const baudRateSelect = document.getElementById('baudRate');
            const dataBitsSelect = document.getElementById('dataBits');
            const paritySelect = document.getElementById('parity');
            const stopBitsSelect = document.getElementById('stopBits');

            if (baudRateSelect) {
                baudRateSelect.value = storedBaudRate;
            }
            if (dataBitsSelect) {
                dataBitsSelect.value = storedDataBits;
            }
            if (paritySelect) {
                paritySelect.value = storedParity;
            }
            if (stopBitsSelect) {
                stopBitsSelect.value = storedStopBits;
            }

            if (storedSerialPort) {
                pendingSerialPortValue = storedSerialPort;
                if (serialPortsLoaded) {
                    setSerialPortSelection(storedSerialPort);
                    pendingSerialPortValue = null;
                }
            } else {
                toggleCustomSerialPort('');
            }
        }

        function cleanAddress() {
            const container = document.getElementById('inputContainer');
            container.innerHTML = '';
            inputButtonDisplay(); // Toggle the bottom action bar if needed
        }

        function initAddresses() {
            const addresses = JSON.parse(localStorage.getItem('addresses'));
            if (addresses) {
                cleanAddress();
                addresses.forEach(addr => addInput(addr.name, addr.id, addr.type));
            } else {
                addInput('', '', '4');
            }
        }

        function saveAddresses() {
            const rows = document.querySelectorAll('.input-row');
            const addresses = Array.from(rows).map(row => {
                const nameInput = row.querySelector('.input-address-name');
                const addrInput = row.querySelector('.input-address');
                const typeSelect = row.querySelector('.type-select');
                return {
                    name: nameInput.value,
                    id: addrInput.value,
                    type: typeSelect.value
                };
            });
            localStorage.setItem('addresses', JSON.stringify(addresses));
        }

        function configureServer() {
            const responseDisplay = document.getElementById('configResponse');
            responseDisplay.textContent = '';
            responseDisplay.classList.remove('error');

            const button = document.getElementById('configureButton');
            const slaveIdInput = document.getElementById('slaveId');
            const slaveId = parseInt(slaveIdInput.value, 10);

            if (isNaN(slaveId) || slaveId < 0 || slaveId > 247) {
                alert("Enter a valid slave ID (0-247).");
                return;
            }

            const payload = {
                mode: connectionMode,
                slave_id: slaveId,
            };

            if (connectionMode === 'tcp') {
                const hostValue = document.getElementById('host').value.trim();
                const portValue = parseInt(document.getElementById('port').value, 10);

                if (!hostValue) {
                    alert("Enter a valid host.");
                    return;
                }
                if (isNaN(portValue) || portValue < 1 || portValue > 65535) {
                    alert("Enter a valid port (1-65535).");
                    return;
                }

                payload.tcp = {
                    host: hostValue,
                    port: portValue,
                };

                localStorage.setItem('host', hostValue);
                localStorage.setItem('port', portValue.toString());
            } else {
                const portSelect = document.getElementById('rtuPortSelect');
                const customPortInput = document.getElementById('rtuPortCustom');
                const baudRate = parseInt(document.getElementById('baudRate').value, 10);
                const dataBits = parseInt(document.getElementById('dataBits').value, 10);
                const parity = document.getElementById('parity').value;
                const stopBits = parseInt(document.getElementById('stopBits').value, 10);

                let serialPort = '';
                if (portSelect.value === CUSTOM_SERIAL_OPTION) {
                    serialPort = customPortInput.value.trim();
                } else {
                    serialPort = portSelect.value;
                }

                if (!serialPort) {
                    alert("Select or enter a serial port.");
                    return;
                }

                payload.rtu = {
                    port: serialPort,
                    baud_rate: baudRate,
                    data_bits: dataBits,
                    parity: parity,
                    stop_bits: stopBits,
                };

                localStorage.setItem('rtuPort', serialPort);
                localStorage.setItem('rtuBaudRate', baudRate.toString());
                localStorage.setItem('rtuDataBits', dataBits.toString());
                localStorage.setItem('rtuParity', parity);
                localStorage.setItem('rtuStopBits', stopBits.toString());
            }

            localStorage.setItem('slaveId', slaveId.toString());
            localStorage.setItem('connectionMode', connectionMode);

            button.disabled = true;  // Disable button to prevent duplicate submissions
            button.textContent = 'Connecting...';  // Update button label to show loading state

            fetch('/set-server', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(j => {
                        throw new Error('Something went wrong [' + response.status + '] ' + j.error);
                    });
                }
                return response.json();
            })
            .then(() => {
                responseDisplay.textContent = 'Connected!';
                responseDisplay.classList.remove('error');
                updateConnectionStatus();
                startConnectionStatusWatcher();
            })
            .catch(error => {
                responseDisplay.textContent = error?.message ?? String(error);
                responseDisplay.classList.add('error');
            })
            .finally(() => {
                button.disabled = false;  // Restore the button state
                button.textContent = 'Connect';  // Restore the original button text
            });
        }

        function inputButtonDisplay() {
            const container = document.getElementById('inputContainer');
            if (container.children.length > 10) {
                const inputButtonBottom = document.getElementById('input-button-bottom');
                inputButtonBottom.style.display = 'block';
            } else {
                const inputButtonBottom = document.getElementById('input-button-bottom');
                inputButtonBottom.style.display = 'none';
            }
        }

        var sortDirection = false;

        function sortInputRows() {
            const container = document.getElementById('inputContainer');
            let rows = Array.from(container.getElementsByClassName('input-row'));

            let nullDefault = 655300;
            if (sortDirection) {
                nullDefault = 0;
            }

            // Read each input-address value and compare numerically
            rows.sort((a, b) => {
                const aValue = parseInt(a.querySelector('.input-address').value, 10) || nullDefault;
                const bValue = parseInt(b.querySelector('.input-address').value, 10) || nullDefault;
                if (sortDirection) {
                    return bValue - aValue;
                }
                return aValue - bValue;
            });

            // Clear the container and append the sorted rows
            container.innerHTML = '';
            rows.forEach(row => container.appendChild(row));

            // Toggle the sort direction
            sortDirection = !sortDirection;
            if (sortDirection) {
                document.querySelectorAll('.button-sort-addr').forEach(button => button.textContent = '↑ Sort Addresses');

            } else {
                document.querySelectorAll('.button-sort-addr').forEach(button => button.textContent = '↓ Sort Addresses');
            }
        }

        const typeOptions = [
            { value: '1', text: 'Coil (0x01)', writable: true },
            { value: '2', text: 'Discrete Input (0x02)', writable: false },
            { value: '3', text: 'Input Register (0x04)', writable: false },
            { value: '4', text: 'Holding Register (0x03)', writable: true }
        ];

        const writableTypeOptions = typeOptions.filter(option => option.writable);

        function addInput(name = '', addr = '', type = '4') {
            const container = document.getElementById('inputContainer');
            const inputRow = document.createElement('div');
            inputRow.className = 'input-row';

            const addrNameInput = document.createElement('input');
            addrNameInput.type = 'text';
            addrNameInput.placeholder = 'Label (optional)';
            addrNameInput.value = name;  // Set the default value
            addrNameInput.className = 'input-address-name';


            const typeSelect = document.createElement('select');
            typeSelect.className = 'type-select';
            typeOptions.forEach(option => {
                let opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                opt.selected = option.value === type; // Select the matching option by default
                typeSelect.appendChild(opt);
            });

            const addrInput = document.createElement('input');
            addrInput.type = 'text';
            addrInput.placeholder = 'Address';
            addrInput.value = addr;  // Set the default value
            addrInput.className = 'input-address';

            const decimalSpan = document.createElement('span');
            decimalSpan.className = 'decimal';
            decimalSpan.textContent = 'Value';

            const bytesSpan = document.createElement('span');
            bytesSpan.className = 'bytes';
            bytesSpan.textContent = 'Bytes Value';

            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'X';
            removeBtn.className = 'remove-btn';
            removeBtn.onclick = function() { removeInputRow(inputRow); }; // Attach the event handler

            inputRow.appendChild(addrNameInput);
            inputRow.appendChild(addrInput);
            inputRow.appendChild(typeSelect);
            inputRow.appendChild(decimalSpan);
            inputRow.appendChild(bytesSpan);
            inputRow.appendChild(removeBtn);
            container.appendChild(inputRow);

            saveAddresses();
            autoCal();  // Rebind double-click shortcuts after adding a row
            inputButtonDisplay(); // Toggle the bottom action bar if needed
        }

        function removeInputRow(row) {
            // Remove the row from the DOM
            row.parentNode.removeChild(row);
            saveAddresses();
            inputButtonDisplay(); // Toggle the bottom action bar if needed
        }

        function callApi() {
            saveAddresses()
            const results = document.querySelectorAll('.result');
            const rows = document.querySelectorAll('.input-row');
            const data = Array.from(rows).map(row => {
                const address = row.querySelector('.input-address').value; // Address input field
                const type = row.querySelector('.type-select').value; // Register type dropdown

                return {
                    register_type: parseInt(type, 10), // Ensure the type is numeric
                    address: parseInt(address, 10) // Ensure the address is numeric
                };
            });

            
            fetch('/get-value', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ids: data,
                })
            })
            .then(response => {
                if (!response.ok) {
                    // Throw an error that the catch block can handle
                    return response.json().then(j => {
                        throw new Error('Something went wrong [' + response.status + '] ' + j.error);
                    });
                }
                return response.json(); // Return the JSON payload
            })
            .then(data => {
                const rows = document.querySelectorAll('.input-row');
                data.forEach((result, index) => {
                    const decimalValue = result.decimal; // Assuming result object has a 'decimal' key
                    const bytesValue = result.bytes.join(' '); // Assuming result object has a 'bytes' key, join bytes into a string
                    rows[index].querySelector('.decimal').textContent = `${decimalValue}`;
                    rows[index].querySelector('.bytes').textContent = `Bytes: ${bytesValue}`;
                });
            })
            .catch(error => {
                alert(error.message); // Display error notification
            });
        }

        function initWriteRows() {
            if (writeRowsInitialized) {
                return;
            }

            writeRowsInitialized = true;

            let storedRows = [];
            try {
                storedRows = JSON.parse(localStorage.getItem('writeRows')) || [];
            } catch (error) {
                storedRows = [];
            }

            if (!Array.isArray(storedRows) || storedRows.length === 0) {
                addWriteRow();
            } else {
                storedRows.forEach(row => {
                    addWriteRow(row.name || '', row.address || '', row.type || '4', row.value || '');
                });
            }
        }

        function addWriteRow(name = '', addr = '', type = '4', value = '', statusText = '') {
            const container = document.getElementById('writeContainer');
            if (!container) {
                return;
            }

            const row = document.createElement('div');
            row.className = 'write-row';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Label (optional)';
            nameInput.className = 'write-name';
            nameInput.value = name;

            const typeSelect = document.createElement('select');
            typeSelect.className = 'write-type-select';
            writableTypeOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                opt.selected = option.value === type;
                typeSelect.appendChild(opt);
            });

            const addressInput = document.createElement('input');
            addressInput.type = 'number';
            addressInput.placeholder = 'Address';
            addressInput.className = 'write-address';
            addressInput.value = addr;

            const valueInput = document.createElement('input');
            valueInput.type = 'number';
            valueInput.placeholder = 'Value';
            valueInput.className = 'write-value';
            valueInput.value = value;

            const statusSpan = document.createElement('span');
            statusSpan.className = 'write-status';
            statusSpan.textContent = statusText;

            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'X';
            removeBtn.className = 'remove-btn';
            removeBtn.addEventListener('click', () => {
                row.remove();
                saveWriteRows();
            });

            const persistHandler = () => {
                statusSpan.textContent = '';
                statusSpan.classList.remove('error');
                saveWriteRows();
            };

            nameInput.addEventListener('input', persistHandler);
            typeSelect.addEventListener('change', persistHandler);
            addressInput.addEventListener('input', persistHandler);
            valueInput.addEventListener('input', persistHandler);

            row.appendChild(nameInput);
            row.appendChild(typeSelect);
            row.appendChild(addressInput);
            row.appendChild(valueInput);
            row.appendChild(statusSpan);
            row.appendChild(removeBtn);

            container.appendChild(row);
            saveWriteRows();
        }

        function saveWriteRows() {
            const rows = Array.from(document.querySelectorAll('.write-row')).map(row => {
                return {
                    name: row.querySelector('.write-name')?.value || '',
                    type: row.querySelector('.write-type-select')?.value || '4',
                    address: row.querySelector('.write-address')?.value || '',
                    value: row.querySelector('.write-value')?.value || ''
                };
            });
            localStorage.setItem('writeRows', JSON.stringify(rows));
        }

        function cleanWriteRows() {
            const container = document.getElementById('writeContainer');
            if (!container) {
                return;
            }
            container.innerHTML = '';
            addWriteRow();
        }

        function focusFirstWriteRow() {
            if (operationMode !== 'write') {
                return;
            }
            const firstAddress = document.querySelector('.write-row .write-address');
            if (firstAddress) {
                firstAddress.focus();
            }
        }

        function callWriteApi() {
            saveWriteRows();
            const rows = Array.from(document.querySelectorAll('.write-row'));
            if (rows.length === 0) {
                return;
            }

            const items = [];
            const statusRefs = [];

            rows.forEach(row => {
                const typeSelect = row.querySelector('.write-type-select');
                const addressInput = row.querySelector('.write-address');
                const valueInput = row.querySelector('.write-value');
                const statusSpan = row.querySelector('.write-status');

                if (statusSpan) {
                    statusSpan.textContent = '';
                    statusSpan.classList.remove('error');
                }

                const address = parseInt(addressInput?.value, 10);
                const value = parseInt(valueInput?.value, 10);
                const registerType = parseInt(typeSelect?.value, 10);

                if (Number.isNaN(address) || Number.isNaN(value) || Number.isNaN(registerType)) {
                    if (statusSpan) {
                        statusSpan.textContent = 'Enter valid numbers';
                        statusSpan.classList.add('error');
                    }
                    return;
                }

                if (address < 0 || address > 65535) {
                    if (statusSpan) {
                        statusSpan.textContent = 'Address must be 0-65535';
                        statusSpan.classList.add('error');
                    }
                    return;
                }

                if (value < 0 || value > 65535) {
                    if (statusSpan) {
                        statusSpan.textContent = 'Value must be 0-65535';
                        statusSpan.classList.add('error');
                    }
                    return;
                }

                if (registerType === 1 && value !== 0 && value !== 1) {
                    if (statusSpan) {
                        statusSpan.textContent = 'Coils accept 0 or 1';
                        statusSpan.classList.add('error');
                    }
                    return;
                }

                items.push({
                    register_type: registerType,
                    address: address,
                    value: value
                });
                statusRefs.push(statusSpan);
                if (statusSpan) {
                    statusSpan.textContent = 'Sending...';
                }
            });

            if (items.length === 0) {
                return;
            }

            fetch('/set-value', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ items })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(j => {
                        throw new Error(j.error || 'Failed to write values');
                    }).catch(() => {
                        throw new Error('Failed to write values');
                    });
                }
                return response.json();
            })
            .then(data => {
                const results = Array.isArray(data.results) ? data.results : [];
                statusRefs.forEach((statusSpan, index) => {
                    if (!statusSpan) {
                        return;
                    }
                    const result = results[index];
                    if (result && result.status === 'ok') {
                        statusSpan.textContent = '✓ Written';
                        statusSpan.classList.remove('error');
                    } else {
                        const message = result && result.error ? result.error : 'Write failed';
                        statusSpan.textContent = message;
                        statusSpan.classList.add('error');
                    }
                });
            })
            .catch(error => {
                statusRefs.forEach(statusSpan => {
                    if (!statusSpan) {
                        return;
                    }
                    statusSpan.textContent = error.message;
                    statusSpan.classList.add('error');
                });
            });
        }

        function convertFrom(sourceId, base) {
            const sourceInput = document.getElementById(sourceId);
            if (!sourceInput) {
                return;
            }

            const rawValue = sourceInput.value ?? '';
            const sanitized = sanitizeInput(rawValue, base);
            if (!sanitized) {
                resetInputs();
                return;
            }

            if (!isValidForBase(sanitized, base)) {
                resetInputs();
                return;
            }

            const parsedValue = parseInt(sanitized, base);
            if (Number.isNaN(parsedValue)) {
                resetInputs();
                return;
            }

            const bitWidth = determineBitWidth(sourceId, sanitized, parsedValue, base);
            const modulo = bitWidth === 32 ? 0x100000000 : 0x10000;
            const unsignedValue = wrapUnsigned(parsedValue, modulo);
            const signedValue = unsignedValue >= modulo / 2 ? unsignedValue - modulo : unsignedValue;

            const unsigned16 = wrapUnsigned(parsedValue, 0x10000);
            const signed16 = unsigned16 >= 0x8000 ? unsigned16 - 0x10000 : unsigned16;

            const unsigned32 = wrapUnsigned(parsedValue, 0x100000000);
            const signed32 = unsigned32 >= 0x80000000 ? unsigned32 - 0x100000000 : unsigned32;

            const binaryValue = formatBinary(bitWidth === 32 ? unsigned32 : unsigned16, bitWidth);

            setInputValue('binary', binaryValue);
            setInputValue('decimal', (bitWidth === 32 ? unsigned32 : unsigned16).toString(10));
            setInputValue('decimalm', (bitWidth === 32 ? signed32 : signed16).toString(10));
            setInputValue('U16', formatHex(unsigned16, 4));
            setInputValue('S16', formatHex(unsigned16, 4));
            setInputValue('U32', bitWidth === 32 ? formatHex(unsigned32, 8) : '');
            setInputValue('S32', bitWidth === 32 ? formatHex(unsigned32, 8) : '');
        }

        function sanitizeInput(value, base) {
            let trimmed = (value || '').trim();
            if (!trimmed) {
                return '';
            }

            if (base === 16) {
                let sign = '';
                if (trimmed.startsWith('-')) {
                    sign = '-';
                    trimmed = trimmed.slice(1);
                } else if (trimmed.startsWith('+')) {
                    trimmed = trimmed.slice(1);
                }
                trimmed = trimmed.replace(/0x/gi, '').replace(/\s+/g, '');
                return (sign + trimmed).toUpperCase();
            }

            if (base === 2) {
                return trimmed.replace(/\s+/g, '');
            }

            return trimmed;
        }

        function isValidForBase(value, base) {
            const patternByBase = {
                2: /^-?[01]+$/,
                10: /^-?\d+$/,
                16: /^-?[0-9a-fA-F]+$/
            };
            const pattern = patternByBase[base];
            return pattern ? pattern.test(value) : true;
        }

        function determineBitWidth(sourceId, sanitized, value, base) {
            if (sourceId === 'U32' || sourceId === 'S32') {
                return 32;
            }

            if (sourceId === 'decimal') {
                if (value < 0 || value > 0xFFFF) {
                    return 32;
                }
                return 16;
            }

            if (sourceId === 'decimalm') {
                if (value < -0x8000 || value > 0x7FFF) {
                    return 32;
                }
                return 16;
            }

            if (sourceId === 'binary') {
                return sanitized.length > 16 ? 32 : 16;
            }

            if (base === 16 && sanitized.replace(/^-/, '').length > 4) {
                return 32;
            }

            if (Math.abs(value) > 0xFFFF) {
                return 32;
            }

            return 16;
        }

        function wrapUnsigned(value, modulo) {
            const wrapped = ((value % modulo) + modulo) % modulo;
            return wrapped;
        }

        function formatHex(value, digits) {
            return value.toString(16).toUpperCase().padStart(digits, '0');
        }

        function formatBinary(value, bitWidth) {
            return value.toString(2).padStart(bitWidth, '0');
        }

        function setInputValue(id, value) {
            const input = document.getElementById(id);
            if (!input) {
                return;
            }
            input.value = value;
        }

        function resetInputs() {
            document.getElementById('binary').value = '';
            document.getElementById('decimal').value = '';
            document.getElementById('decimalm').value = '';
            document.getElementById('U16').value = '';
            document.getElementById('U32').value = '';
            document.getElementById('S16').value = '';
            document.getElementById('S32').value = '';
        }

        function downloadSelected() {
            const selectElement = document.getElementById('resourceSelect');
            const selectedValue = selectElement.value; // Read the selected option

            // Create a hidden anchor to trigger the download
            const link = document.createElement('a');
            link.href = `/downloads/${selectedValue}`; // Build the download URL
            link.setAttribute('download', ''); // Set the download attribute
            document.body.appendChild(link); // Attach the anchor to the page
            link.click(); // Click the anchor programmatically
            document.body.removeChild(link); // Remove the anchor afterwards
        }
    </script>
</body>
</html>
